(()=>{"use strict";const o="https://kite.zerodha.com/positions",e="https://console.zerodha.com/account/segment-activation?killswitch=0",t="https://kite.zerodha.com/positions?exit=0",n="User_Stock_Opening_Bal",c="Loss_Date";function l(o,e){var t={};t[o]=e,chrome.storage.local.set(t,(function(){console.log("Data saved:",t)}))}function i(o,e){chrome.storage.local.get(o,(function(t){console.log("Data loaded:",t),e&&e(t[o])}))}var r=!1;function a(o,e,n,i,s){try{if(o&&n){var u=document.querySelector(".open-positions tfoot td:nth-last-child(2)").textContent;console.log("Obtained text from  position "+u),u=u.replaceAll(",","");var g=parseFloat(n)/100*parseFloat(e);if(r){var m=parseFloat(100-n)/100*parseFloat(e),d=(new Date).toISOString();console.log("Current time : "+d),console.log("Current Stop loss amount : "+g),console.log("minimum profit : "+(m-o)),console.log("Current balance : "+e),r=!1}var p=parseFloat(u);if(console.log("Opening balance : "+o),console.log(" currentPositionSummaryAmount : "+p),m=parseFloat(100-n)/100*parseFloat(e),console.log("minimum profit : "+(m-o)),console.log("current_Bal : "+e),console.log(" stop_loss_amount : "+g),console.log(" comparison "+(o+p<=e-g)),console.log("======================================================="),o+p<=e-g)console.log("stop loss hit you are saved enjoy!"),console.log("Opening balance : "+o),console.log(" currentPositionSummaryAmount : "+p),console.log("current_Bal : "+e),console.log(" stop_loss_amount : "+g),m=parseFloat(100-n)/100*parseFloat(e),console.log("minimum profit : "+(m-o)),d=(new Date).toISOString(),l(c,d),h=t,chrome.runtime.sendMessage({action:"navigateToNewPage",url:h});else{if(p>=s){var f;e+=f=e==o?p:p-(e-o),g+=f,r=!0,s+=i}setTimeout((function(){a(o,e,n,i,s)}),1e3)}}}catch(t){console.log("Got error while iterating on the positions re-iterating again",t),setTimeout((function(){a(o,e,n,i,s)}),2e3)}var h}function s(o){chrome.runtime.sendMessage({action:"navigateToPage",url:o})}const u=window.location.href;u.includes("https://kite.zerodha.com/"),u.includes("https://kite.zerodha.com/funds")&&setTimeout((function(){!function(){const o=document.querySelector("div.six.columns");var e;o&&(o.querySelector("h3.title span.name").textContent.trim().toLowerCase().includes("equity")&&(o.querySelectorAll("table.table tbody tr").forEach((o=>{"Opening balance"===o.querySelector("td:first-child").textContent.trim()&&(e=o.querySelector("td:nth-child(2)").textContent.trim())})),e=e.replace(/,/g,""),l(n,parseFloat(e))))}(),s(o)}),2e3),u.includes(o)&&!u.includes(t)&&setTimeout((function(){i(n,(function(o){var e=o;console.log("User_Stock_Opening_Bal:",e),i("Trailing_Stop_Loss_Percentage",(function(o){console.log("User_Trailing_Stop_Loss_Percentage:",o);var t=parseFloat(o)/100*parseFloat(e);i("Stop_Loss_Percentage",(function(o){var n=o;console.log("User_Provided_Stop_Loss_Percentage:",n),a(e,e,n,t,t)}))}))}))}),2e3),u==e&&setTimeout((function(){var o=new Date;i(c,(function(e){if(null!=e){var t=new Date(e);t.toDateString()===o.toDateString()&&(console.log("Today's input: "+t),l=!1,(c=Date.now()+3e4,function o(){try{n=document.querySelectorAll("input")}catch(e){Date.now()<c&&setTimeout(o,1e3)}}(),n).forEach((function(o){o.checked&&(l=!0,o.checked=!1)})),l&&(setTimeout((function(){for(var o=document.querySelectorAll(".btn.btn-blue"),e=0;e<o.length;e++)if("Continue"===o[e].textContent.trim()){o[e].click();break}console.log("kill switch clicked")}),5e3),setTimeout((function(){for(var o=document.querySelectorAll(".modal-container button.btn.btn-blue"),e=0;e<o.length;e++)if("Continue"===o[e].textContent.trim()){o[e].click(),console.log("kill switch clicked");break}console.log("kill switch clicked")}),5e3)))}var n,c,l}))}),3e3),u==t&&setTimeout((function(){var o=new Date;i(c,(function(t){if(null!=t){var n=new Date(t);n.toDateString()===o.toDateString()&&(console.log("Today's input: "+n),function(){var o=document.querySelectorAll(".data-table tbody tr");try{o.forEach((function(o){o.querySelector('.su-checkbox-group input[type="checkbox"]').click()}))}catch(o){console.log("ignored error while clicking on the check boxes",o)}try{setTimeout((function(){document.querySelector(".button-blue").click(),setTimeout((function(){document.querySelector(".modal-container").querySelector(".button-blue").click(),setTimeout((function(){s(e)}),2e3)}),2e3)}),2e3)}catch(o){console.log("could not exit market",o),s(e)}}())}}))}),2e3)})();